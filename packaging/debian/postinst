#!/bin/sh
set -e

case "$1" in
  configure)
    # Create client config directory
    [ ! -d /etc/drlm/clients ] && mkdir /etc/drlm/clients
    [ ! -d /etc/drlm/alerts ] && mkdir /etc/drlm/alerts

    # Create directory for rear client logs
    [ ! -d /var/log/drlm/rear ] && mkdir /var/log/drlm/rear
    chmod 775 /var/log/drlm/rear

    # Check if /etc/exports.d directory is present
    [ ! -d /etc/exports.d ] && mkdir /etc/exports.d && chmod 755 /etc/exports.d

    # Check if /etc/rsyncd.d directory is present
    [ ! -d /etc/rsyncd.d ] && mkdir /etc/rsyncd.d && chmod 755 /etc/rsyncd.d

    # Unpack GRUB files
    tar --no-same-owner -xzf /var/lib/drlm/store/boot/grub/grub2.04rc1_drlm_i386-pc_i386-efi_x86_64-efi_powerpc-ieee1275.tgz -C /var/lib/drlm/store/boot/grub

    # Check if drlm.key has been generated in older installations.
    if [ ! -f /etc/drlm/cert/drlm.key ]; then
        openssl req -newkey rsa:4096 -nodes -keyout /etc/drlm/cert/drlm.key -x509 -days 1825 -subj "/C=ES/ST=CAT/L=GI/O=SA/CN=$(hostname -s)" -out /etc/drlm/cert/drlm.crt
    fi
    
    # Update old database or create new one running drlm_db_version script.
    /usr/share/drlm/conf/DB/drlm_db_version.sh

    # Save rsynd.conf if exists 
    if [ -f /etc/rsyncd.conf ]; then
      mv /etc/rsyncd.conf /etc/rsyncd.conf.$(date +"%Y%m%d%H%M%S").drlm.save
    fi
    # Save rsyncd.motd if exists 
    if [ -f /etc/rsyncd.motd ]; then
      mv /etc/rsyncd.motd /etc/rsyncd.motd.$(date +"%Y%m%d%H%M%S").drlm.save
    fi

    # Add rsyncd.conf file
    cp /usr/share/drlm/conf/rsyncd/rsyncd.conf /etc/rsyncd.conf
    # Add rsyncd.motd file
    cp /usr/share/drlm/conf/rsyncd/rsyncd.motd /etc/rsyncd.motd

    # Stop previos drlm services if exists
    systemctl is-active --quiet drlm-stord.service && systemctl stop drlm-stord.service
    systemctl is-active --quiet drlm-api.service && systemctl stop drlm-api.service
    if [ -f "/var/run/rsyncd.pid" ]; then
      kill $(cat /var/run/rsyncd.pid)
    fi

    # Add systemd drlm services
    cp /usr/share/drlm/conf/systemd/drlm-stord.service /etc/systemd/system/
    if [ $(systemctl --version | head -n 1 | cut -d' ' -f2) -lt 229 ]; then
        sed -i "s/TimeoutSec=infinity/TimeoutSec=0/g" /etc/systemd/system/drlm-stord.service
    fi
    cp /usr/share/drlm/conf/systemd/drlm-api.service /etc/systemd/system/

    # Reload systemd services
    systemctl daemon-reload

    # Enable systemd services
    systemctl enable tftpd-hpa.service
    systemctl enable nfs-kernel-server.service
    systemctl enable rpcbind.service
    systemctl enable isc-dhcp-server.service
    systemctl enable drlm-stord.service
    systemctl enable drlm-api.service

    # Start drlm services
    systemctl start drlm-stord.service
    systemctl start drlm-api.service
    rsync --daemon    

    # Set debian like DHCP an NFS service names
    [ -f /etc/drlm/local.conf ] && echo "DHCP_SVC_NAME=\"isc-dhcp-server\"" >> /etc/drlm/local.conf
    [ -f /etc/drlm/local.conf ] && echo "NFS_SVC_NAME=\"nfs-kernel-server\"" >> /etc/drlm/local.conf

    ;;

  *)
    echo "postinst called with unknown argument \`$1'" >&2
    exit 0
    ;;
    
esac

exit 0
